# Screener - System Configuration
# Multi-Timeframe Momentum Reversal Trading System
#
# This file contains system-level configuration: logging, database, IB connection, etc.
# Trading strategy parameters are in trading_params.yaml

# ===== Interactive Brokers Configuration =====
ib:
  # ===== Connection Presets =====
  # Select active profile by setting IB_PROFILE environment variable
  # Default: tws_paper (safest option)
  active_profile: "${IB_PROFILE:tws_paper}"

  # Connection profiles (all use localhost)
  profiles:
    tws_paper:                      # ✅ RECOMMENDED: TWS Paper Trading
      name: "TWS Paper Trading"
      host: "127.0.0.1"
      port: 7497
      description: "Trader Workstation - Paper Trading Account"
      safe_for_testing: true

    tws_live:                       # ⚠️ WARNING: TWS Live Trading
      name: "TWS Live Trading"
      host: "127.0.0.1"
      port: 7496
      description: "Trader Workstation - LIVE ACCOUNT"
      safe_for_testing: false

    gateway_paper:                  # ✅ RECOMMENDED: Gateway Paper Trading
      name: "IB Gateway Paper Trading"
      host: "127.0.0.1"
      port: 4002
      description: "IB Gateway - Paper Trading Account"
      safe_for_testing: true

    gateway_live:                   # ⚠️ WARNING: Gateway Live Trading
      name: "IB Gateway Live Trading"
      host: "127.0.0.1"
      port: 4001
      description: "IB Gateway - LIVE ACCOUNT"
      safe_for_testing: false

  # Connection settings
  client_id: "${IB_CLIENT_ID:1}"    # Unique client ID (1-32)
  timeout: 20                       # Connection timeout (seconds)
  readonly: false                   # Set true for data-only mode (no order placement)

  # Data fetching
  request_delay: 0.5                # Delay between API requests (seconds) - IB rate limit
  max_concurrent_requests: 50       # Max concurrent data requests
  historical_request_timeout: 60    # Timeout for historical data requests

  # Real-time data subscriptions
  realtime:
    enable: true                    # Enable real-time data streaming
    bar_size: "5 mins"              # Primary bar size for real-time (5-min per user request)
    aggregate_to:                   # Aggregate 5-min bars to these timeframes
      - "15 mins"
      - "1 hour"
      - "4 hours"

  # Reconnection settings
  auto_reconnect: true              # Auto-reconnect on disconnect
  max_reconnect_attempts: 5         # Max reconnection attempts
  reconnect_delay: 10               # Delay between reconnect attempts (seconds)

  # SAFETY: Connection validation
  validate_connection:
    check_account_type: true        # Verify account type (paper vs live)
    warn_on_live: true              # Show warning if connecting to live account
    require_confirmation_for_live: true  # Require explicit confirmation for live

# ===== Database Configuration =====
database:
  # Database type (override with DB_TYPE environment variable)
  type: "${DB_TYPE:sqlite}"         # sqlite or postgresql

  # SQLite (development/testing)
  sqlite:
    path: "${DB_PATH:./data/trading.db}"
    timeout: 30
    check_same_thread: false

  # PostgreSQL (production)
  postgresql:
    host: "${DB_HOST:localhost}"
    port: "${DB_PORT:5432}"
    name: "${DB_NAME:trading_system}"
    user: "${DB_USER:trader}"
    password: "${DB_PASSWORD:}"
    pool_size: "${DB_POOL_SIZE:10}"
    max_overflow: 20
    pool_timeout: 30
    pool_recycle: 3600              # Recycle connections after 1 hour

  # Query optimization
  echo: false                       # Log all SQL queries (debug only)
  query_timeout: 10                 # Query timeout (seconds)

  # Backup
  backup:
    enable: true
    schedule: "17:00"               # Daily backup time
    retention_days: 30              # Keep backups for 30 days
    path: "./data/backups"

# ===== Logging Configuration =====
logging:
  # Log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
  level: "${LOG_LEVEL:INFO}"

  # Log format
  format: "<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>"

  # File logging
  file:
    enable: true
    path: "${LOG_DIR:./logs}"
    filename: "trading_{time:YYYY-MM-DD}.log"
    rotation: "00:00"               # Rotate daily at midnight
    retention: "${LOG_RETENTION_DAYS:90} days"
    compression: "gz"               # Compress old logs
    level: "INFO"

  # Console logging
  console:
    enable: true
    colorize: true
    level: "INFO"

  # Module-specific log levels
  modules:
    ib_insync: "WARNING"            # Reduce IB API verbosity
    urllib3: "WARNING"
    sqlalchemy: "WARNING"

  # Performance logging
  performance:
    enable: true
    log_slow_queries: true
    slow_query_threshold_ms: 100    # Log queries slower than 100ms
    log_screening_time: true
    log_indicator_calc_time: true

# ===== Data Storage Configuration =====
storage:
  # Directory paths (override with environment variables)
  data_dir: "${DATA_DIR:./data}"
  historical_dir: "${HISTORICAL_DATA_DIR:./data/historical}"
  cache_dir: "${CACHE_DIR:./data/cache}"

  # Historical data storage
  historical:
    format: "parquet"               # Parquet format (columnar, compressed)
    compression: "snappy"           # Snappy compression
    partitioning: "symbol"          # Partition by symbol
    structure: "{symbol}/{timeframe}.parquet"

  # Cache settings
  cache:
    indicator_ttl: "${INDICATOR_CACHE_TTL:300}"  # 5 minutes
    max_size_mb: 1000               # Max cache size (1GB)
    cleanup_interval: 3600          # Cleanup every hour

# ===== Performance Tuning =====
performance:
  # Parallel processing
  max_workers: "${MAX_WORKERS:8}"   # Number of parallel workers
  chunk_size: 100                   # Symbols per parallel batch

  # Memory management
  max_memory_usage_pct: 80          # Max memory usage before warning
  gc_interval: 3600                 # Garbage collection interval (seconds)

  # Data fetching optimization
  prefetch_symbols: 10              # Prefetch data for next N symbols
  batch_indicator_calc: true        # Batch indicator calculations

# ===== Dashboard Configuration =====
dashboard:
  # Server settings
  host: "${DASHBOARD_HOST:0.0.0.0}"
  port: "${DASHBOARD_PORT:8050}"
  debug: "${DASHBOARD_DEBUG:false}"
  dev_tools_hot_reload: false

  # Update intervals (seconds)
  update_intervals:
    watchlist: "${WATCHLIST_UPDATE_INTERVAL:15}"
    charts: "${CHART_UPDATE_INTERVAL:60}"
    regime: "${REGIME_UPDATE_INTERVAL:1800}"
    positions: "${POSITION_UPDATE_INTERVAL:5}"

  # UI settings
  theme: "bootstrap"                # Bootstrap theme
  suppress_callback_exceptions: true

  # Chart settings
  charts:
    max_bars: 200                   # Max bars to display on chart
    default_timeframe: "15 mins"
    show_indicators: true
    show_volume: true

# ===== Alert Configuration =====
alerts:
  # Email (requires SMTP configuration in .env)
  email:
    enable: "${ENABLE_EMAIL_ALERTS:false}"
    smtp_server: "${EMAIL_SMTP_SERVER}"
    smtp_port: "${EMAIL_SMTP_PORT:587}"
    from_address: "${EMAIL_FROM}"
    to_addresses:
      - "${EMAIL_TO}"
    use_tls: true

  # Slack (requires webhook URL in .env)
  slack:
    enable: "${ENABLE_SLACK_ALERTS:false}"
    webhook_url: "${SLACK_WEBHOOK_URL}"
    channel: "#trading-alerts"
    username: "Screener Bot"
    icon_emoji: ":chart_with_upwards_trend:"

  # Dashboard alerts
  dashboard:
    enable: true
    max_alerts: 50                  # Max alerts to display
    retention_hours: 24             # Keep alerts for 24 hours

# ===== Development/Testing Configuration =====
development:
  # Paper trading (CRITICAL: Always true in development)
  paper_trading: "${ENABLE_PAPER_TRADING:true}"

  # Testing flags
  skip_ib_connection: "${SKIP_IB_CONNECTION:false}"
  use_sample_universe: "${USE_SAMPLE_UNIVERSE:false}"
  sample_universe_size: "${SAMPLE_UNIVERSE_SIZE:50}"

  # Profiling
  enable_profiling: "${ENABLE_PROFILING:false}"
  profiling_output: "./data/profiling"

  # Mock data
  use_mock_data: false              # Use cached/mock data instead of live
  mock_data_path: "./data/mock"

# ===== Security Configuration =====
security:
  # API security
  validate_all_inputs: true         # Validate all external inputs
  sanitize_queries: true            # Sanitize all database queries

  # Order validation
  require_pre_trade_validation: true  # NEVER disable this
  double_check_live_orders: true    # Extra validation for live orders

  # Credentials
  never_log_credentials: true       # Never log sensitive data
  use_environment_vars: true        # Prefer env vars over config

# ===== Monitoring Configuration =====
monitoring:
  # Health checks
  enable: true
  interval: 60                      # Health check every 60 seconds

  # Metrics to monitor
  metrics:
    - "ib_connection_status"
    - "data_feed_latency"
    - "memory_usage"
    - "disk_usage"
    - "database_connection_pool"
    - "indicator_calc_time"
    - "screening_time"

  # Alert thresholds
  thresholds:
    max_data_latency_sec: 30        # Alert if data >30s delayed
    max_memory_usage_pct: 90
    max_disk_usage_pct: 90
    max_screening_time_sec: 40

  # System health
  heartbeat_interval: 60            # Send heartbeat every 60s
  restart_on_critical_error: false  # Auto-restart on critical errors

# ===== Timezone Configuration =====
timezone:
  system: "America/New_York"        # NYSE/NASDAQ timezone
  market_hours:
    start: "09:30"
    end: "16:00"
  premarket:
    start: "04:00"
    end: "09:30"
  postmarket:
    start: "16:00"
    end: "20:00"

# ===== Feature Flags =====
features:
  # Trading features
  enable_auto_trading: false        # Enable automatic order placement
  enable_position_tracking: true
  enable_trailing_stops: true
  enable_time_exits: true

  # Analysis features
  enable_accumulation_analysis: true  # Component 3 (Stoch/RSI ratio)
  enable_regime_analysis: true
  enable_multi_timeframe: true

  # Dashboard features
  enable_5min_chart: true           # Show 5-min chart (per user request)
  enable_alerts: true
  enable_performance_tracking: true

  # Experimental features
  enable_machine_learning: false    # Future: ML-enhanced scoring
  enable_options_trading: false     # Future: Options strategies
